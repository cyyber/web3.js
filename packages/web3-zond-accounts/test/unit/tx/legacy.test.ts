/*
This file is part of web3.js.

web3.js is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

web3.js is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with web3.js.  If not, see <http://www.gnu.org/licenses/>.
*/
import { RLP } from '@ethereumjs/rlp';
import { bytesToHex, hexToBytes, uint8ArrayEquals } from '@theqrl/web3-utils';
import {
	Chain,
	Common,
	Hardfork,
	intToUint8Array,
	toUint8Array,
	//uint8ArrayToBigInt,
	unpadUint8Array,
} from '../../../src/common';

import { Transaction } from '../../../src';
import type { TxData } from '../../../src';
import txFixturesEip155 from '../../fixtures/json/ttTransactionTestEip155VitaliksTests.json';
import txFixtures from '../../fixtures/json/txs.json';

describe('[Transaction]', () => {
	const transactions: Transaction[] = [];

	it('cannot input decimal or negative values', () => {
		const values = ['gasPrice', 'gasLimit', 'nonce', 'value', 'v', 'r', 's'];
		const cases = [
			10.1,
			'10.1',
			'0xaa.1',
			-10.1,
			-1,
			BigInt(-10),
			'-100',
			'-10.1',
			'-0xaa',
			Infinity,
			-Infinity,
			NaN,
			{},
			true,
			false,
			// eslint-disable-next-line @typescript-eslint/no-empty-function
			() => {},
			Number.MAX_SAFE_INTEGER + 1,
		];
		for (const value of values) {
			const txData: any = {};
			for (const testCase of cases) {
				txData[value] = testCase;
				expect(() => {
					Transaction.fromTxData(txData);
				}).toThrow();
			}
		}
	});

	it('Initialization', () => {
		const nonEIP2930Common = new Common({ chain: Chain.Mainnet, hardfork: Hardfork.Istanbul });
		expect(Transaction.fromTxData({}, { common: nonEIP2930Common })).toBeTruthy();

		const txData = txFixtures[3].raw.map(toUint8Array);
		txData[6] = intToUint8Array(45); // v with 0-parity and chain ID 5
		let tx = Transaction.fromValuesArray(txData);
		expect(tx.common.chainId() === BigInt(5)).toBe(true);

		txData[6] = intToUint8Array(46); // v with 1-parity and chain ID 5
		tx = Transaction.fromValuesArray(txData);
		expect(tx.common.chainId() === BigInt(5)).toBe(true);

		txData[6] = intToUint8Array(2033); // v with 0-parity and chain ID 999
		tx = Transaction.fromValuesArray(txData);
		expect(tx.common.chainId()).toEqual(BigInt(999));

		txData[6] = intToUint8Array(2034); // v with 1-parity and chain ID 999
		tx = Transaction.fromValuesArray(txData);
		expect(tx.common.chainId()).toEqual(BigInt(999));
	});

	it('Initialization -> decode with fromValuesArray()', () => {
		for (const tx of txFixtures.slice(0, 4)) {
			const txData = tx.raw.map(toUint8Array);
			const pt = Transaction.fromValuesArray(txData);

			expect(bytesToHex(unpadUint8Array(toUint8Array(pt.nonce)))).toEqual(tx.raw[0]);
			expect(bytesToHex(toUint8Array(pt.gasPrice))).toEqual(tx.raw[1]);
			expect(bytesToHex(toUint8Array(pt.gasLimit))).toEqual(tx.raw[2]);
			expect(pt.to?.toString()).toEqual(tx.raw[3]);
			expect(bytesToHex(unpadUint8Array(toUint8Array(pt.value)))).toEqual(tx.raw[4]);
			expect(bytesToHex(pt.data)).toEqual(tx.raw[5]);
			expect(bytesToHex(toUint8Array(pt.publicKey))).toEqual(tx.raw[6]);
			expect(bytesToHex(toUint8Array(pt.signature))).toEqual(tx.raw[7]);

			transactions.push(pt);
		}
	});

	// it('Initialization -> should accept lesser r values', () => {
	// 	const tx = Transaction.fromTxData({ r: uint8ArrayToBigInt(toUint8Array('0x0005')) });
	// 	expect(tx.r!.toString(16)).toBe('5');
	// });

	// it('Initialization -> throws when creating a a transaction with incompatible chainid and v value', () => {
	// 	let common = new Common({ chain: Chain.Goerli, hardfork: Hardfork.Petersburg });
	// 	let tx = Transaction.fromTxData({}, { common });
	// 	expect(tx.common.chainId()).toEqual(BigInt(5));
	// 	const privKey = hexToBytes(txFixtures[0].privateKey);
	// 	tx = tx.sign(privKey);
	// 	const serialized = tx.serialize();
	// 	common = new Common({ chain: Chain.Mainnet, hardfork: Hardfork.Petersburg });
	// 	expect(() => Transaction.fromSerializedTx(serialized, { common })).toThrow();
	// });

	// it('Initialization -> throws if v is set to an EIP155-encoded value incompatible with the chain id', () => {
	// 	expect(() => {
	// 		const common = new Common({ chain: 42, hardfork: Hardfork.Petersburg });
	// 		Transaction.fromTxData({ v: BigInt(1) }, { common });
	// 	}).toThrow();
	// });

	it('validate() -> should validate with string option', () => {
		for (const tx of transactions) {
			expect(typeof tx.validate(true)[0]).toBe('string');
		}
	});

	it('getBaseFee() -> should return base fee', () => {
		const tx = Transaction.fromTxData({});
		expect(tx.getBaseFee()).toEqual(BigInt(53000));
	});

	it('getDataFee() -> should return data fee', () => {
		let tx = Transaction.fromTxData({});
		expect(tx.getDataFee()).toEqual(BigInt(0));

		tx = Transaction.fromValuesArray(txFixtures[3].raw.map(toUint8Array));
		expect(tx.getDataFee()).toEqual(BigInt(1716));

		tx = Transaction.fromValuesArray(txFixtures[3].raw.map(toUint8Array), { freeze: false });
		expect(tx.getDataFee()).toEqual(BigInt(1716));
	});

	it('getDataFee() -> should return correct data fee for istanbul', () => {
		const common = new Common({ chain: Chain.Mainnet, hardfork: Hardfork.Istanbul });
		let tx = Transaction.fromTxData({}, { common });
		expect(tx.getDataFee()).toEqual(BigInt(0));

		tx = Transaction.fromValuesArray(txFixtures[3].raw.map(toUint8Array), {
			common,
		});
		expect(tx.getDataFee()).toEqual(BigInt(1716));
	});

	it('getDataFee() -> should invalidate cached value on hardfork change', () => {
		const common = new Common({ chain: Chain.Mainnet, hardfork: Hardfork.Byzantium });
		const tx = Transaction.fromValuesArray(txFixtures[0].raw.map(toUint8Array), {
			common,
		});
		expect(tx.getDataFee()).toEqual(BigInt(656));
		tx.common.setHardfork(Hardfork.Istanbul);
		expect(tx.getDataFee()).toEqual(BigInt(240));
	});

	it('getUpfrontCost() -> should return upfront cost', () => {
		const tx = Transaction.fromTxData({
			gasPrice: 1000,
			gasLimit: 10000000,
			value: 42,
		});
		expect(tx.getUpfrontCost()).toEqual(BigInt(10000000042));
	});

	it('serialize()', () => {
		for (const [i, tx] of transactions.entries()) {
			const s1 = tx.serialize();
			const s2 = RLP.encode(txFixtures[i].raw);
			expect(uint8ArrayEquals(s1, s2)).toBe(true);
		}
	});

	it('serialize() -> should round trip decode a tx', () => {
		const tx = Transaction.fromTxData({ value: 5000 });
		const s1 = tx.serialize();

		const s1Rlp = toUint8Array(bytesToHex(s1));
		const tx2 = Transaction.fromSerializedTx(s1Rlp);
		const s2 = tx2.serialize();

		expect(uint8ArrayEquals(s1, s2)).toBe(true);
	});

	it('hash() / getMessageToSign(true) / getMessageToSign(false)', () => {
		const common = new Common({
			chain: Chain.Mainnet,
			hardfork: Hardfork.TangerineWhistle,
		});

		let tx = Transaction.fromValuesArray(txFixtures[3].raw.slice(0, 6).map(toUint8Array), {
			common,
		});
		expect(() => {
			tx.hash();
		}).toThrow();
		tx = Transaction.fromValuesArray(txFixtures[3].raw.map(toUint8Array), {
			common,
		});
		expect(tx.hash()).toEqual(
			hexToBytes('0x375a8983c9fc56d7cfd118254a80a8d7403d590a6c9e105532b67aca1efb97aa'),
		);
		expect(tx.getMessageToSign()).toEqual(
			hexToBytes('0x61e1ec33764304dddb55348e7883d4437426f44ab3ef65e6da1e025734c03ff0'),
		);
		expect(tx.getMessageToSign(false)).toHaveLength(6);
		expect(tx.hash()).toEqual(
			hexToBytes('0x375a8983c9fc56d7cfd118254a80a8d7403d590a6c9e105532b67aca1efb97aa'),
		);
	});

	it('hash() -> with defined chainId', () => {
		const tx = Transaction.fromValuesArray(txFixtures[4].raw.map(toUint8Array));
		expect(bytesToHex(tx.hash())).toBe(
			'0x0f09dc98ea85b7872f4409131a790b91e7540953992886fc268b7ba5c96820e4',
		);
		expect(bytesToHex(tx.getMessageToSign())).toBe(
			'0xf97c73fdca079da7652dbc61a46cd5aeef804008e057be3e712c43eac389aaf0',
		);
	});

	it("getMessageToSign(), getSenderPublicKey() (implicit call) -> verify EIP155 signature based on Vitalik's tests", () => {
		for (const tx of txFixturesEip155) {
			const pt = Transaction.fromSerializedTx(toUint8Array(tx.rlp));
			expect(bytesToHex(pt.getMessageToSign())).toEqual(tx.hash);
			expect(bytesToHex(pt.serialize())).toEqual(tx.rlp);
			expect(pt.getSenderAddress().toString()).toBe(`0x${tx.sender}`);
		}
	});

	it('getMessageToSign(), sign(), getSenderPublicKey() (implicit call) -> verify EIP155 signature before and after signing', () => {
		// Inputs and expected results for this test are taken directly from the example in https://eips.ethereum.org/EIPS/eip-155
		const txRaw = [
			'0x09',
			'0x4a817c800',
			'0x5208',
			'0x3535353535353535353535353535353535353535',
			'0x0de0b6b3a7640000',
			'0x',
		];

		// TODO(rgeraldes24) - add correct data to seed
		const seed = hexToBytes(
			'72e3cf696c4680c3ab310774df1e898d32a0abd1988007e6e334d2a8d517f8f3b3d411bd8584cfec683008f8e8d498f9255deab75e3bc901c3460dcf5bb7334ec54c2556e4d823cee9a264b49769ee419dd82c9a2ac8f663b65fa3c64630ac1790422aa3a26811372de2208e643645d0a48992b26154186d420851484028d8308ae1440a1b3982d3480ee4245082948cd438884bc6114c80414c186c9b960ccb282563a02c5b1204224041d112641a3705403020218840538230a44001888644e4423291b0698b404d0114604a26658102209822715140612102441ab1100b28901420111c870119b489dc867000c80503b10103a00051b82cd4962089462e14a790d1424a5b26325cc28d203410dba66019028e98200c11a26cc01425c84691d3a66809328ea1426509c8011c034c224611d234090c4325924628cc10281c320681326d88484a980432a4824d109931a28649d9c880501482a1042e0aa40910912c60344813072241c82d48429021412298a241e3246e14342d4a466c9492605bc8289cb28958b08c98a824d8a2211c898100144ca096900b042d5a2809d33482c0166121450d0a29281199681cb72c0c2066249960c39891daa04493c025ccc88580805014462e1bc98894a00d09398d1124911c946922348a202652d9321253408ac4360290a62424b304134981123851d0042d11070d91086d24a725c8023122494419a345230100cab470a146611438058a302042269219248e141841c9b4606424300c874413194202806064120d20958c02a42d1c362ed1182909372409028d1c808d09198090a24101321052b68012a341840692892249a02649e0b66d52185111332201b5054ba44898b865603481c1944104842c01a94883c08d51242e1303305384310b200d1837405b808c9b300648426e2322701a071100104241b88091443118114cc8b6880a23028498118b08919b4405d1b001112282d8c62d1934811a11690ac02cdb226cc14005c44409d8a844c2024c1c235092a26181b281d9262dc4904913240ec00826e0b84dd0c8681c098e21b445c300410245898cc4240cc26ce4a06113236454004984c4211bb769c4a82d99a8058338861c234de1429220b2240a3982d4040502c1451143500c202944060922b68562a445939070db407000258a0111500c4526101269c320050c3420e1000910408d98b28161440223412d49a0295906005230709c32086448001c1832089170dc182c49466ce4a0089b88849c486813256dd89805d446280814610ba9405c342c51a029521869d2420ccc326d0c118c84282a0a912009c7518a464dc84066d8184e533026a412014bb60990b22122b86061946c004431193731403061cbc08c022251d228604c1872cb92682128261284654100201b326a429004e400858018280cc568c00428200746240485149350db2821dc882851a45049464981343162108c91c849da021143c24c00b92912026dd0367259188263c07189087212208292328612a591cb208681c20821224e19b765a1c8052247660b128114410424060aa0806922b36c62884401996d8a400201002a192680cb4060e4368d0b382c5a122163402803b548d3442900422c53260e039290833882c046700115208cb44560a84c0231251ab6109b328581902503360859a42de0b870600822ca18826312061b3549da14816122061cb40c1c3624000904d1a831c3a28823412ce4244d00202e8404690007811a3544d2340a2027610b944911308118a2640b292d908225043021d2b00090b04452264208414d9130311c984104998818384923424a13816150924c6284281007858220011b302902a9451848499016711ab62452c60490c86d1117428a406d498460631652d22050c2448618c3051c0581200088984226189750641081a1c851902421118324d202698a1624140904584850a33620203092c944710c896951b624cb464ddc40226404660b2765830630c904618b260de1189262b625c3a06c122791e1a0652100656100250227529c121093006a00b1818b324e94b2855906319b32081022298996085124660208809c8648cc260421174ae3168d5c160d990644e116500c2352d1441201a68091124ccb904963c20420c66c42b27085ba1e4b1ab2a5cd1cfa5bfbbb410e18a5b442b6148bce4a5511b040884612bd402049b23539eb2ab508832aa4f7078dcadcf154feb86f2751fc2c3696a9dd16bbfc9630f1196abe4c3e2012946e0ba6fc9bd9207217c08beb29f6a40177b56147c74585a5009b656a05984b8aea6c4193a29abfcfdbb96ac145fa8cc7db515d116126297e07a54a76f4a5e010343c4db68d6056d973a5c6aa9d0d5c9dae7d11a6d4efff73205d9d69ced9eabed73b4e73e721f037e0cb1728ea1bfc04b8185eedc34c061edb9b6d451c7b287fd0194b0a22ac0b93509c40449c11681b1f6bd489022e1b30f60123b549d136f2a99055cbbbd62a81cbb37d0ba95db233d4a69ee85b266fcac7765708ac0fcb2b179510861eaf4bfd74f21d2364f6d66561653a4e9e129d9288fb6510bc0a4b4188e7896a1de586455fb623ebfcc9374bb05632f7d2ce352707faa10c4c7f55c9ee70d10eabca5e375e18763f7d6de37118a8f89cc496d5b9411d88678439fce0581435a1aefe255b0d23e41ce1ba7f425498f826d41d392e6408bc4fc620b2cd8b4c276e8acf5b89a97dcde53cd7de1a01052c7fe8c5cbc0fc34f461cb461ebb69dcc6cf9eeabb36c71ec3128e85b94b4e4e383fa925ae471b47a7e8ab1e540f4c88bb3af74b0bc58ea25979c0381f8bda0891080f6fd8c13483ba42a60c41b4df3e5fb9f7a3df10f2101e83deb169e8df76c64f331ff968179db738c0948124f1bbe8597d86b96f52531ded8bd128acb2e2b67879c943d14e16602b57fb303617a9faf435969102c31e4b167cc75a82252dfde73f01ef77eed74b27c8a45f09e61067e8fecc65cdfd1a0c9c24b230b26817c84ba22c4c8ed594a866d4c58fa997da726be714781eaf40aff3837f0884ce881445d639c768b76e156c3aec9d7d3652b62a9c8b68053d90845f3d3b7315800acc7f8d44798c63100c7b6f393a20be0fdfedf5c607b5a8559da66a05231613851d2b59e0dc971f9c8da2a41593c691e24bcd94ed583b3673d913b1ac10a7ee6e1c9f3e4d92fb8927186498320a6083504da3eb0e373f14b89bf237a297ed91de3f51a200e8f9a14a1ec13668106455c886fc14ce127e034dcd22ed32725585441c357ba9b20ae03b32b867a9ede0182bdb5589593d4343437cea8a8256dfcae588a27ea90e5db9afbee033b3141b395ec4b8438f5f6dea62770c49903e0d4f1bfeb7db4b9cfd7631a44ff5dd719b9727e24cd3e9c24ad9c0c237845b5e24aad076114d8b6ac7de5de4026f9c9e70f4410beef8c46645375c696f241860a68c9e7c7d19887700b0337624a0bb582b3ee961fdc7046a72cbf2635233efcfe4c247a24c5a5e9a82ec48e81636fac232663c5eef4373e3424b0e3454ec7407f22473dd95a5dce7196e268b49ce6f69fc0d8351de9701e156fdbd2027bbf9507fa53f73ee304a48aba5ad7716965ce49960ac14b574022354ff88b7ded0de2318fe84de4b319d737b42ef7da2cb07ff58aa2a013037f3955ffb1ff469e3ddb4d3a5dbaa1c491131eea711061d55f1a3017df1f8a6d0a30b31ae1ac7b8197d1af23e20eba5933c09db5ba8ff4cec2e4a2fdd9f3e04d4b9270d29b81cb66e5ea5e5354a42a06cea0346ca109d3f546fddf5028ee70ffae96c597b4a3151c5466b96b57c907e309589679eb89e3fe559e6c8c170c845f92362a6c7f0f5fb85cc270637780aabdc6cebd081ba3927319182008ff53550eecdb1d4f8a17950e8102de93c85457cde388b990ac9c8a32a8b606ad6824ea388ff7dec103b9f583223ea1764a86b3bae3ecf8e9e414d2963dc36c4fc0f2b13333199d8890e8d1f3b6c506b96fa41507ae3416df9ee00fe9b4a69f8fe4135d3484efae512b2475efe054371c335efa8a71baaf5d188749d418e9bb8034b4a779cac224d63fcdf4d986d29f5e2380e33f27566dce8d074481b2929f8d322a29dd2792d91f704404d5f2d1dab72b45c7f06b86adc9091bcee6f7cb9f782c1a41ebf77e3545ef7cb9ec95ce01f5a22c3d8824b224f9dcb405cf1a161d010b81a36213b9800310e535db71248ef3112d2d76f16f113a0d553c726d36021621ef9c5afd20682a8763e1e5df008e6a1fccc332f1636da6a8d6ed4f788915ecd5f5f0e8bed5fd1f14e3b3b2d8b79584a959de2fbc9f23f7059cc089e204f8b0a22cd2981a5a3d73c3f78cee1416d943dd94d82244afc4aa08dd66ddf82991901330694478fc44c85609dce70019e621a7dbcbec7ba0a401c9e955e7acca840c439de6f72a86abcf4b3342645fc02f8fc3a54fd6f3c6c2143ff115f66036c8a26034e80ac42efc345ca78fd0f63064e45773d74eb2e23453df00cd7fea0e67d8a2c073848a24e4cb978854fe51d267c4f8932a0cf5e60f72c792f9497fcc09462e9b58fbcfbb582c8258953a79d0547a955a8f69948dc0b0acfa9e86e300804cb5ee2fa32e9d8d641e146bd6edee55ca4aa2f3bbc4720026e025925d5ddccdd2b214f0a5e3dffd0d3ead28fc6e6834f0c3cbf14af3d14ca8368dc7d825f4958485d355ccc844327c98feef8b51d9963a91b2eeb1fd2b8215d85e34b3686044562ee97c1433dfefd3173a024aa65d502ac86b5c616ad9299ddd27ce8761ac3ff0df6a4f230d2a2dd090decc6d014bc8749981ceb85744c38a274990655e7315e540cabe67b745c46c58c9bfbf9b47297314bfd2459b9093c3674a04516bf9c27935cd14df7d1d67fd04bff1fac3a4477f1550eb3442879953c06c2f4aca9e0f8d1ee44a5f7ba3b7285e56df60e8b14b279ec9987e107368c58c685cbcb9d655707ae7cbf37df43552d5bd6887b5bb5b4373eb98202fb1c30c1b8351151695fc07873b63379e2b076aaa3af7037bbd2339530109ae586d1b5787678b94ca9aae889e6796b70cf69457852818d0b63ec1432dcc5c89b70202baf249fd444845c376cb9bbd86713416b7866d27cda4e3ee9165e94f32121ff1b977f05f4d5898a0c90f6aa7617b50979414a96b308d332c3fed832011bd57a72e4cfeba99113f96fa38aef69491657516dfa71f6ff36fab1d362fb2f41f0141e0fd574a94b5ec719a01621a6fc909444b572de60984a76d9198d8f76756d7021316c7ad2986f6797bf976c15c48ab0353986214c811a7b06abdee5135e95445d3119c5bb025ab95d7e4bcbb671e0cedbbb3f5adfcdb4457ae533927339b5a041098d6388d22b576dd9cc62d9e979981e65c71397e82c444308977d4c6decb8f64c70f8f14f06d03f5929c8ca713583819e9a38d1187f89fab24114b1d27e4898a288904d28653da78b7309202debbc4c49f3250b4307c659de75547c23fbe32bb4d6a9a82b2337cc6161607fc90d300f7a3e1712638a0a7857ebd23e9405db1079d9bcbaf5a6a11f94ae395a05837b8cf0696dcb1af91663428eeda8fa6789712cfeb60b3a8a28d8c7c060e6b8ef23d21e13e86d120410a3ce217c01ad0f95214a1c5a9955ad297093595aca4f47087d3e29da0ccd8644e93f833c7887a844816ec13fe7c1bec62009f1a1f27fc7504398f23c8dc5c2470c43dab514a7915f520bc25f166d3c5253da1c51bbaf6b4be46626206c9f23b6ed7105b02f511d8c2a6d7cedef8b882c1d2a5feecbdd4024b74e4d12c13117982321d7939ffa987ddab6a468942d97f8238e17a17d478792604ed59bd79d8b12c3c222ca2c61a33d03ded47504eeec8098c568853dbce3c6656af014a5cfbb62d6af2c1064fb4d32ae03156ac7f151c0985534bc3edd2815878316bf7843f7a9f4fbbb288f2bda56401bde98fdd6a6445320859080469add6ad8403b8d16d49c67cd93f97a79f1be521d0e705a128ef1e528ab2e874351c2b09e39d2df9677e8e98bdeb5310335ae6c69200418869f811ca85f7478ac07ce3085d4ac1471826e48442ecacd364caa26053d10d8e2c575b84a96ffefa992c2c2b997d1525c874434cbf8fc81eed05b5bef3967806bda1a975770dcfcd0047328d32999038f1fbc4529038d2497ccf3565d7eb1bb8f5fcec88c0020126ecc27b01ea2fe3c9e045db42df90f3c3f931179f1f6b13d7a733dc4f6b4acafeaded76e08af4f3e61d96c1a976304502c0df8cb0752d0a7e03ddbc2e3c171dd4aaeaec5cba0560698baf7a4068cc69d91f437c0712a4d039cdd88c3707d2d3ad6ff84d1cc54d2ba9ec765222aed4c81f70aa6ccf36cca0b20e30ec085dd980707c5133dbc209bdc16c88271fcffdd61ce2340348b9f08bb785094d8ed0bb7de38f6b2ff9ed6b5eba009e30c08377e098e6e94c26f89d531204a9c4e0d151888dae3d79ad0a5e1396edd923e2c91535a37401ad387b57464ec66f8ebeb23fd5419314b4ee5f8edeefbc9521fa2a10030ad5e2558443ba2f1469aeb276407cfc3472d00f9306a06abc10f1009d3af9ddc5c7d6de9c425afa3ec2e1a908ef42a50cc00a96ee62edf77cfdbe682292e099a865947220306182aa434230dd09fd3612db809d1376e208f47e5e754ad6ac6df1c96e40bb4f3dd7380c7ce3b3e138ac6f77fa60c9d81318f0ad90a023e798cafd0a6b90ff98dcfa36917c005bdcfba3798027379bf169e4bb6e7ac220bdb2505a0e85606e940fdec56807d5efdb794804fd554f55fdfbc7376a6f6f616086699d63649370e3c7f7da1f8c8dcab84adab7dda04cc0489d26828482ec5bc7e64',
		);
	
		const pt = Transaction.fromValuesArray(txRaw.map(toUint8Array));

		// Note that Vitalik's example has a very similar value denoted "signing data".
		// It's not the output of `serialize()`, but the pre-image of the hash returned by `tx.hash(false)`.
		// We don't have a getter for such a value in Transaction.
		expect(bytesToHex(pt.serialize())).toBe(
			'0xec098504a817c800825208943535353535353535353535353535353535353535880de0b6b3a764000080808080',
		);
		const signedTx = pt.sign(seed);
		expect(bytesToHex(signedTx.getMessageToSign())).toBe(
			'0xdaf5a779ae972f972197303d7b574746c7ef83eadac0f2791ad23db92e4c8e53',
		);
		expect(bytesToHex(signedTx.serialize())).toBe(
			'0xf86c098504a817c800825208943535353535353535353535353535353535353535880de0b6b3a76400008025a028ef61340bd939bc2195fe537567866003e1a15d3c71ff63e1590620aa636276a067cbe9d8997f761aecb703304b3800ccf555c9f3dc64214b297fb1966a3b6d83',
		);
	});

	it('sign(), getSenderPublicKey() (implicit call) -> EIP155 hashing when singing', () => {
		const common = new Common({ chain: 1, hardfork: Hardfork.Petersburg });
		for (const txData of txFixtures.slice(0, 3)) {
			const tx = Transaction.fromValuesArray(txData.raw.slice(0, 6).map(toUint8Array), {
				common,
			});

			const seed = hexToBytes(txData.seed);
			const txSigned = tx.sign(seed);

			expect(txSigned.getSenderAddress().toString()).toBe(`0x${txData.sendersAddress}`);
		}
	});

	it('sign(), serialize(): serialize correctly after being signed with EIP155 Signature for tx created on ropsten', () => {
		const txRaw = [
			'0x1',
			'0x02540be400',
			'0x5208',
			'0xd7250824390ec5c8b71d856b5de895e271170d9d',
			'0x0de0b6b3a7640000',
			'0x',
		];
		const seed = hexToBytes(
			'DE3128752F183E8930D7F00A2AAA302DCB5E700B2CBA2D8CA5795660F07DEFD5',
		);
		const common = new Common({ chain: 1 });
		const tx = Transaction.fromValuesArray(txRaw.map(toUint8Array), { common });
		const signedTx = tx.sign(seed);
		expect(bytesToHex(signedTx.serialize())).toBe(
			'0xf86c018502540be40082520894d7250824390ec5c8b71d856b5de895e271170d9d880de0b6b3a76400008026a05e5c85a426b11e1ba5d9b567e904818a33975962942f538d247cd7391f5fb27aa00c8ec23ca4a3cdc2515916e4adc89676ce124fd7d0ddbb3ddd37c441dd584c21',
		);
	});

	it('sign(), verifySignature(): should ignore any previous signature when decided if EIP155 should be used in a new one', () => {
		const txData: TxData = {
			data: '0x7cf5dab00000000000000000000000000000000000000000000000000000000000000005',
			gasLimit: '0x15f90',
			gasPrice: '0x1',
			nonce: '0x01',
			to: '0xd9024df085d09398ec76fbed18cac0e1149f50dc',
			value: '0x0',
		};

		const seed = hexToBytes(
			'a1b67d6dd15d9acce3f5a31c8ec4d2766dad7fecf72225f0ada7ee4e7c804acab22ce97117b6fa9a510486e6c2594387dab4b501cf81eb97f1adeb69ff3044f349a06964de6e68691232b75420c4f49c5b3627ef4f7730aeb598b587ba50f67c4208418c968898248d43c6291980301123615bc82800330c02004c60a8841b14860326221324910247411343890138455a802849c84cd90210a1286c98b6848a3488d04811a206488aa84863128cc9a249102124e1320a4228490cc5312214259020288a8284c9c42c240028e39404239451204160234322e3004a8a36828ab28c449801dab010c190455948925bc0019422702335810032401c324e5b9041e022455c209293284e088309490066c8b89023b96cc1a064619849d0025163103243b04408b9281cb9600b180a50280e0c136c88b84989428d8b1466583662242911021728ca20910c0520a3b024a2242d0ab50dc4c400534421e1a608914450892281c9c8251a8905e496911c898504324148348148129202b7040329302482810016319944051b964820b120a1b48d92484d1c355082129213a4251129261b390819c390d32092a4324e04032c11312813c84de21225c1323282144219058918170a430825c1460920c909d2308182c449c8c48901266412318582c409e0360e9ab691980881842400db244c03356a14160c99c0818c8600a3b28c5184400a159200228ecbb69160344910906c14c909581052cab46d21468ca0a65114342e4220268a286218974841026c411684a2965164940d811424db162c12c824439048dbb40449a250921249d992704918029938450c4722d21829243606642868cc420dc0424213c08898c80c142549532811cca6818382400ba6111b234c1b992191184dcb045184388e5cb811c9826808440ed9c4448b444e24454e81124004056892288188c08d144740c082310c960c1cc48911b025510626c2a46c5ac27023058981b2500c8890d980012317422114691aa541e4b62c0ac52d1c485181c468e4268824352a132350db866104250edb14516036829aa04c53983111130c5c440ae1b6518ac000190471a0b85051220941028cc19669cb4266d8b829d9822050428210352450444819806c0b92644b46644a084e1ab051d8066a0200840b85811c05440405410096251c3150c0827194a889440420241702d924208990048922300ac12550a88d24086253a68de224060bb80021b530c8b4890bc34808c26502c0441907125bc89011040894344284185012170508022d21813022328e21388809284158988158284918928c22218800842190a03102150ccc9609da028e9c285140c80da0248592346a20c20000a10d203810244631c032812405524030065c122212082044c65163b640db0442c8c8901c020e6492080b022ae4b8801a2040a1186aa3860514250601b3409122051bc35143082c8440800c49514c446422380614959009b088a0046c48c80ce2c83163c044ca948ddc20242424818002884b204a00c04d622089034151a00029ca14311ac285c4223092246688a41144c84898047224968902862d24b165a12041ca200d1ab30d58a089900271e0120a004029e0364609c98804b60d192908c8240c90922910364e8ba86c528468da90601ca001c40622a0282a14308044c451c02051c8b4808094018ab49040c05048140ac2b66021a885520251a4069091c800540448192084a1c828db427202402012436a193029a40400e12886d8942c942610832402611480a1186c542421a036840343464c240042906d22a944e22485dab4045312691b216654280ce3248c08c0859c4008549290d13686249244c40690e4142d90b06023324da4b289109160e2002621b22064362113c3411a4029a4880408924022112210128520116863268563301091284a5406468924006330240aa98c5c0065d8140588260e40184cd2044293902d640052c4240a00104a62828d114812930441639221841811631850080326130812db92091b124594306603852020489104080100164c41860cdbc66542b601e326321a212112402561302e1840041a284652a00914338e51884d21110dc3c68884a25191c050929400924406dac8906430484a307011478aa23088143508e3f08c712288424dc5336009fc62fc633412b5327e255e45a6f1922b25e4ae1eea230530fb75c372d12af3d5e2cd5efde59e485cdcef1e9b19e4ade97472f94cb8d043f9c6f7571ead8567b0a70cfcac1ba32cd75e6d14b2622b53b4d3d2a9dd1df6224a72e2162c268298abd8a37435504630a567f8e6c5f0b9c5bbc26717db46cbe65060ec442aed93a3775c95adc5f612b0f504d7ea536dcfd1882e3549a987b74d3070b5dc563073d30a9286c58abeb7d041e40c44deadf28b2af0db03b3591abb25151021a96d3f6871d752b93bf19cabb9a7d58ad83b72a8e93f77943783c5023834245cc561f65d2eb759e8861418dbcdb5df15cf567ecc34fdf3c5d07e94a6b4509ef1b28b9f9a2d5fe59355241bae410bbea1fc71f731b2b1c510adc8a94ce168c839cb8f9262a823dd5199ed766b4b1d37204516f79786814651597991e159eb211e015c536e4d971d0ea5f183e0d7c1c5a3905849110a6e0b8d292c5f736b6f34eacf24377f5bc880f17f4fdf4e9c515e1b8dc847cfa1c930b41e3b86285a0e627b3d3f8b0032b49ee3d7d10b1b0b33956f4079518e35dbb3f46e7018819df3a34659d5d64a0ab4ce7c7aedfc5a33edc6340a24fd40fefaba9fb9066782117e41d30d795a696f211e463be6cb2e20ea38e9ebf84eb77a4517bed12400a3cbfcadf9ddc9230229dab7204f29d7cc3b38367b623c78a2d267fc37739db359aa89796f4e3bdeb0b68b6b8b4e3900cf35326810d95d49a59f914af8fd8007ca02659ffa92eb4279053077789ed57fbf41abf5c77be7b5706acd92c5fe08e23b71fc752d5ef5634a6229d0a5dfa69fe44e27534815e84bf38a734061937abf20eb95f9669ac340eef0e7a052579df9cdae1c2924407babfd06fa32a46ccaff8f9e38eb89beb10d23144bc6398b5e13dd38197ce67a0957521e986bfd1d39e3688b03d854b9c220d6c56cf0b9506aa1f5f7d722da7f498e4a21b6de9d48a3f660e217d1b95b1070404a243b14213a7afb95400b52695132dbdf869b714b19a9e457e2fda9b9dfc8edbc6a5c762fa14962af0944ad2cd745fbb93873fb1a3cdfe93373e6d9fadd93be47e867679c6cce35361dd02bd87ff6a9dde8debfcf44dae82a2d8e17f03172721dfd320b1705218245e5be5ed399c20086ed5a14fb2684cec01fa10c39e2de375b5a7d5c50cb333de0930aa8ec7793db7918f59bb8ec6934196df5130292f3e8f713281fc5982df5386551e12c60b9f7967267f1db0b3121e963eebc6b20d42ff7f7a6dbfa33a8abb6a24632ddd2e0e13c9936ef6b04fc1cf007ed3db341c191dee79871f94d51023a49e3bed6a7b10ad19f69a640693720521491701f4e4f21995df15c8e2c0e215a3272d5344ce3aaad67c748f5fb17e397f7340263153c2c79e51a608de52754f3d8ce49c9179d58a48daa527d61079161b93e8280ea4276421da9a56ee7bdc52aa9dacd547e016153de339b62068494fe3856c9979880a70070d36254834f89890ddee5552c23c06500f6c638e06d573ec32995b6196ab920053309619cc984404c727bdd9465ad66a2fd55c7e722d79f8e18fa13164542f4ae7db51ccf2f5b3676cf35e51866a3b301b278802eed85683ae22a405a5350745c410d0ae27b3e159b6a8776db2463938c6190d3d0a2e32e7cd6c42bb3bf70deb61fe9c627247df5d7beb507621bb5837844b7a48c42264edcd9613c39b291f2a05a83d819671d2881add6ef2369e694d740791926fe552b4ad795bcac682605b13035e11959b1ca881127e4def052d6bb3545ebc8a0e8a6d730243125353cbee6f08ad5695d4252f32156bf7e9dcca049bc65e35891a5f5ff319be1ccd0a1d01718078b3027c22bb5d2e52ba0430c8d760ead2513fd0ba62e1666a83b7a46fc10500a83ccc53b4b9fa5221327094eaa601bfe3874d06cb1414dd0ae0c31a581c6f6c74b0a19ed9ea8b5d2437fd0cc10b161cf41ca9df1e0cc7e244e24ab20609cf05163e2f69b624c3a33a1d628638b5296e16b214a99c4d88be3dde17a120ba82f5c0afc30d5a7dec13644d75133d3c97aa05f4154128be8dde9cd5e0ac157613ed13aea7a4adb7a8a463029e6ea9d2598c89c7bd45cb3b6ab3a82a3ad9b2df524be2d1f7b449583a4a6a581a9591a75b430e81a1654a35d445eaea21db5f439e0110a3f2cdf91fae07c92161bfc2380d02897eb0dd8633c2e66381aed81b0e569670e4ec1cf8d71ce37d785933ca69ecf1c1f768423312a04ee6b54fb14b74dfff6f363ac67c17b72623a71ee93347c668ae214f5af4a6a688dc3340f5924fc3098c5df26ae98a37c909156bc0340861819fc9798213d3f8f7645988811719a57d694a1c5561640188da4beb4190445b895db400cb0dbb944d46b8346b68d3f4a94a02465aeccbb0bdfa6116c926da4a07ef9926688c5042c06f397f04391bacf6b7456b1855c870431b9519864f458d8484e987e09867a8941b81e0c712d2107534e328686a533ea5dd5a94c4193a64f54fbd7a7c7479f6e534d716373a74ff6ee4e7b7e5102fc9743fdb8b597b677107cf0000fd90e3018b0d5b238cb377d0731c07f1df270f63ce7a5190ea479b55f712f7fb32c57e6aa57c221f837cb3ba847c6d01065c366387bfc71a8308d5fe224daed09c8acb865d9ab31e245bdf7388ceaead8897b4513bb6ab56b5ac6742e187c4a4459f38a827a2846069c0a8b2811ea8705e550a0e810b4002d4edd55f494f027768319ccd672afd75b5e53ff9a3344b04052de3a2e8662c4470e53c824babd25b541915e7002f6dd0d7a449041a9066801e5263edd8aee8c291c6226fcdc436f0d522b92fa7e5f2c7878625fa85429f05c4c71110fc0875b5fb142a7cd4328fa6a36cb70a0ce70e8f21df2681a80c6b74bd8ea2ad6ae5893ab2053e5a5b9fb44e7ae1624dec4277bd0e0ce442720b15cbbfd9e3e1c403ad49eb4c01e1f7792b0ff4784b8e49d36bd4011ee15469e5db67c7fcff2008cac31bbc7f7cca495802cb52d474929ee712b34cf34f2f6305a11823b9ed1151687eee900ad401c21e66362fff90f9167972686bd303c0f4e112c3a20e18a607066185494f5d4b9841b7fb1dde8b7930205a5049002ac234c9aead6fa1b19a8fbc4f47c3bf8d988a228cf4db6778d74cf02fd63849e7d3b660ecbafb78bb7a3b835351607c0c72e186fca93a86c0d4f43cdf66c06aa1dd3e14a6ec272803b1c73dbe9bddc242b5720b48198c621da29ed8ffd923d8b77e4ab3a7cc16b0c8c44fe4dd5cbb252615696e374236b111fe756d7ed4cd992441c5982ac3086733f048cd196e2cf423cec64e80b274ff1bfec63edc3709bfa8345e92c40f998eea1dce25e1d4ff3443e960d23bca059810ec48a9b3ede8b5237b436cfdd00474c371b6394dec7cc65376f438acbfd8d4ac5d28e8af631e7ef48e526c94b2c51ad5672d71d88a6d3401db21b4f9dd500324ff445e64201fd583ba826c41672d789353d7bd70ed7df0e5df3365e6b0d20092cc19b9b3932ff5076c2f0995d8132ebb7bacc72ea73599664110b0330c98b177e15642b9f5ad50e62990b91a951df4cc447a5aa75180be0057c68b425ea22227b0bfee7cbaaa5db7b4b5a595aeb1b404ac126d462ded072825a17be30cf08afb7de25c3958d3a30e4bbed4518d9387a30f0f24fe92180978b5c4352babc289e3872114be091d9b66175114654939c5e25c700b962a208f887308857c2c41fadf9e8224288a72399651551b1747e49471ea171a55c0b0e9b52c4edbb5d0dcc48da28731411d093ed81edb7d92d5e535c48fcaa7747bc5721a82af63431ba5eb28a3f26dbf4f30c22df9c08987249fa1ff57b7b612ec071cca54c8c47e63bc45796e562d2c966f9e5ec8ebd897474969221b48b72f1b4dfd01b8f9ae7d69164e42deb1cdf09102c8fd700d897a7abcb7330ca87cbc28576d55ce8f96e58ef9b598cdc47259ed17c58c43f0f5b6a500647cf79d7d5d023b06e43c43290d035047bed93ddec2652894aeaa2df772b3fa4ce00e018423f6e158a5d9e753b71715518d5ce68b9b487352dd36e855fd85f8eb71f67854ecee42f5f9c22eb3abf079d51b37276e4bbb77081bc09de8a251080d70cf5c84e06ac6279f19dc18b7cefb60d9608a4ed6d8740b21e1c6e218eeb17cbf723ca4ecfc0795b5ac791b831631d3ecc6d289b5e5210a6ae86838794a88ca42b5167637ad8a7448375f4db72a5de3186ca6373c2a85993d40f421749ca7008e1c8683429ba645965a0baefacf0dfeab25535f29439054f592596cb15692a960921f03f71992279081b7ffb753d2cc945b68293316f3b1cf984183acf13173f2f9e7ecbb083ced8db30d52ed1014bea04a5f8dbad8c8acbe16b6029b95d46ffdf69d60fcf68d1fecd33d4880fe09abe977b55f888b66e0cefafaf4e3166c5818f228a8c705492d0c929b2b2612c6a94e38adba339efcd313c4c0034860f45155f8cb33b068d8c54ba99041c8863fbe2036ce6468defe75bd195c04d761813b02030de3fa5700e532eb502180625c8ba376382193e95aad596ded4fe6cb0bb72711f4f4dc11ec89537f97dca75dbd3036730df9205096b6ec79c769ea8b8981f4a92485d9ddffb2c45b054d74d6e32d62a4659571eaa6a9d5cb149739710fc6bc4906f7e999d2fdd70b1f993',
		);

		const common = new Common({
			chain: Chain.Mainnet,
			hardfork: Hardfork.TangerineWhistle,
		});

		const fixtureTxSignedWithoutEIP155 = Transaction.fromTxData(txData, {
			common,
		}).sign(seed);
		// eslint-disable-next-line @typescript-eslint/consistent-type-assertions
		let signedWithEIP155 = Transaction.fromTxData(<any>txData).sign(seed);

		expect(signedWithEIP155.verifySignature()).toBe(true);
		// expect(signedWithEIP155.v?.toString(16)).not.toBe('1c');
		// expect(signedWithEIP155.v?.toString(16)).not.toBe('1b');
		// eslint-disable-next-line @typescript-eslint/consistent-type-assertions
		signedWithEIP155 = Transaction.fromTxData(<any>fixtureTxSignedWithoutEIP155.toJSON()).sign(
			seed
		);

		expect(signedWithEIP155.verifySignature()).toBe(true);
		//expect(signedWithEIP155.v?.toString(16)).not.toBe('1c');
		//expect(signedWithEIP155.v?.toString(16)).not.toBe('1b');
		// eslint-disable-next-line @typescript-eslint/consistent-type-assertions
		let signedWithoutEIP155 = Transaction.fromTxData(<any>txData, {
			common,
		}).sign(seed);

		expect(signedWithoutEIP155.verifySignature()).toBe(true);
		//expect(
		//	signedWithoutEIP155.v?.toString(16) === '1c' ||
		//		signedWithoutEIP155.v?.toString(16) === '1b',
		//).toBe(true);
		// eslint-disable-next-line @typescript-eslint/consistent-type-assertions
		signedWithoutEIP155 = Transaction.fromTxData(<any>txData, {
			common,
		}).sign(seed);

		expect(signedWithoutEIP155.verifySignature()).toBe(true);
		// expect(
		// 	signedWithoutEIP155.v?.toString(16) === '1c' ||
		// 		signedWithoutEIP155.v?.toString(16) === '1b',
		// ).toBe(true);
	});

	// it('constructor: throw on legacy transactions which have v !== 27 and v !== 28 and v < 37', () => {
	// 	function getTxData(v: number) {
	// 		return {
	// 			v,
	// 		};
	// 	}
	// 	for (let n = 0; n < 27; n += 1) {
	// 		expect(() => Transaction.fromTxData(getTxData(n))).toThrow();
	// 	}
	// 	expect(() => Transaction.fromTxData(getTxData(29))).toThrow();
	// 	expect(() => Transaction.fromTxData(getTxData(36))).toThrow();

	// 	expect(() => Transaction.fromTxData(getTxData(27))).not.toThrow();
	// 	expect(() => Transaction.fromTxData(getTxData(28))).not.toThrow();
	// 	expect(() => Transaction.fromTxData(getTxData(37))).not.toThrow();
	// });

	it('sign(), verifySignature(): sign tx with chainId specified in params', () => {
		const common = new Common({ chain: Chain.Goerli, hardfork: Hardfork.Petersburg });
		let tx = Transaction.fromTxData({}, { common });
		expect(tx.common.chainId()).toEqual(BigInt(5));

		const seed = hexToBytes(txFixtures[0].seed);
		tx = tx.sign(seed);

		const serialized = tx.serialize();

		const reTx = Transaction.fromSerializedTx(serialized, { common });
		expect(reTx.verifySignature()).toBe(true);
		expect(reTx.common.chainId()).toEqual(BigInt(5));
	});

	it('freeze property propagates from unsigned tx to signed tx', () => {
		const tx = Transaction.fromTxData({}, { freeze: false });
		expect(Object.isFrozen(tx)).toBe(false);
		const seed = hexToBytes(txFixtures[0].seed);
		const signedTxn = tx.sign(seed);
		expect(Object.isFrozen(signedTxn)).toBe(false);
	});

	it('common propagates from the common of tx, not the common in TxOptions', () => {
		const common = new Common({ chain: Chain.Goerli, hardfork: Hardfork.London });
		const seed = hexToBytes(txFixtures[0].seed);
		const txn = Transaction.fromTxData({}, { common, freeze: false });
		const newCommon = new Common({
			chain: Chain.Goerli,
			hardfork: Hardfork.London,
			eips: [2537],
		});
		expect(newCommon).not.toEqual(common);
		Object.defineProperty(txn, 'common', {
			get() {
				return newCommon;
			},
		});
		const signedTxn = txn.sign(seed);
		expect(signedTxn.common.eips()).toContain(2537);
	});

	it('isSigned() -> returns correct values', () => {
		let tx = Transaction.fromTxData({});
		expect(tx.isSigned()).toBe(false);

		const txData: TxData = {
			data: '0x7cf5dab00000000000000000000000000000000000000000000000000000000000000005',
			gasLimit: '0x15f90',
			gasPrice: '0x1',
			nonce: '0x01',
			to: '0xd9024df085d09398ec76fbed18cac0e1149f50dc',
			value: '0x0',
		};
		const seed = hexToBytes(
			'52a3adac2a663a71707700487897edc91f735ac0cc73c24b506744ae9177f79665a543f4b060ec6df6c559c15ae8c41457da868b80174b099cc0a97f274deef2a927a70d157b1a46ef1d8b7bb00e90eac4292bdbce802ee4e9ffc3372a1db226910229a1146259b881a1968cd90889db484a0436890ab1051ba96410800958022480980c42c84c5116302414848880211344419a948161446409497110476c82826862067280344e21b144d1320523c05051046e8b80900912240cb76c510661ca02840ab5851121018ba609a3365124c42018400512141054488a11c20963b22cc1c271a4161224440621292da384684a246e84c09150c0240b8589c9a02dd4907010928c6104868a4428d14270c2b2285ab4510cb80ce220869c464088008824a16cd00024084252548221ca142d020586d0426120a74802205203822960982c18898963222a42449212240c40c20c9cb824dcc2288cc42c5b340a10c830c3c45009470a54266a11910098b82041348a038768613620da986409472513218148086963b6090b038c00a9100a908901a205830612dc32894842210b2520e2400504876854309024454a5804260116222134221327714aa89103c485c112008080815b9669dbc800592864102160480888601809a48491c2c2659b127109b50c89c831d3888118808ca4804c1c40290b022e4102260c114aa1b46cd11669d290851c344c84926c0a369144c46808302e9140026016422319690111204402249a485288061214b9290a92855aa000c0062060b8051439482339898b444883086522b90148b025e4306d00184e81226d4ca04994c049c04849c92600cc422e13252819a94580288c5a187180c064c02271e116405b30044a3486db46615a982c63202a1a342820b97192206a1a4080e1a40002334c0c836590466e0a99402339088880001b266459060e989069930284ca480083424993c66409418ada326844c8701a4568884665cab44dca128990824083301198380da1c82c892820c496895aa2915b8664e0a82d5b000813367059264a94206ad380844b0672c3408919370921c968e02426482082013349d4c22184c8040c06901c980944902122350e03b60c61966da01872003412d24024120661e046905016300a411190920544062543c20050081010488621246c89b865584025c90041c4924c60b22063c889e1866442c840d0348419970c98068893128d9a441280386810282144c8499aa44164289011266da0088dd400695a420e023224002184093246008824d3102c23c26c24026249a08053c48122336821004de0a288db4450024622630824db02091ca549993890482851591410c0400c01290c14c1619b466c1ba76458448c49a85002226c0b256660804523024e20a7612428254c348d229309c1004018352911b0915c8064d21828221730a11241023512a2b641c0340560422a4aa810dbb265e4c280990405184329c3964d04488dc9088c11000d4398309c308d0044905ba8851b976089266858244ed244800022490a984d1382455a80859c1064424832cb18690944311c306151b83010882c43c2111bb8708a8000dcb400081692d994510b162ed8482090302d234460621202c1c860123565a240400c400140c0084c20319c880940a68083a0895ba62c01a78c4a10604a082c1803460ab149c136298b44481a806001a631030724222662dc1829104144a08669cc02726148262181088a204d99c82920958501b740d8184c4a32818418901b0950d140320a120a18b940204272c9268204812ddc322412c0901a186d5aa8910946069c1426a4a08919464580382a4ab83123242c40248502084cd28291a44630cc12015c248912c024dac4118b0080d9406a4014305c10881b37601b138d243690833804011361022631114231403665233128e0960942148e1a458653968011c0294202308448229c346a51c20ca0b4684a369160368e8cb0311b35725ac02509047058045054004c12463060186e643470c9322d8b822dc9a22519c94d6302025a184ad4a889c4c8298122328c2630110166c422610cc5318ac84d08418ed29405c4c44d4142840c306c08b50c14843040b08889304c5a242680080820848054b65008924023488a5c246af2f8e3fa05686c529bd6483a21c180e2fd930eba4edc0cfcfc4097ffc5d790b7eb19aa46d2b086d3a5f54bca4698e391d4b626c202a7da8941a95226fb5ce7b424da87d16c9f2a9f0a0630c58bb19de5baf531591052cd574f9a77b32683077c025531e437b893e69593c0b9dcc12928b8d5d4cfd815007f807cefa0585851170ef2a11c9832d0e1955781512503672e0c3d0ceb12ad11a9c77d40a123d99107505749e12b91fcfa3187d62cb2135fd0e633f183b01a5ff4a7fa3ce408beabf18af6cbf7b1c1804df2f6caf009aca5743093219816be47007724a85e7e139a8f0f730f7566c11279be6222fc46997e50a6f698ee95e8a82f85810510c825c47f362fd42f70bff6b5b5d0e02af7b8263ef9c882fe1c8f278da2fae95167ada1e80f3b36a8aab0f082cfc264b073d4e4cb2edb0f7870e4d2213bad257a71a6b299fa178e37494ccaf20478efb38df9564cbe55a42acfcf1cc687b8f2cfe2df523a2ad07aa836fa0ab1fb07f9915662b7f2d564bf8b2f1688d97130cb8b91fcc721b2e85c7a5f52a3c09e1c3e106ecdb8858238ba66162911f8807b4c154e1bcafd934e755ba99707a218b80bdaab36f4b15858c6edc5bd2779bf7f6fdd74b8a1d84d490a0ff630bbd1eb2a16c4a5d630749126575e0aab4ae685790e21cd79496fb8e23d965d9c4008647b11b1a544ea1e32fc8d2802762f672ca31f0ae296728bbcdcef00d34af776e5113287c7487cd9aded4c25c4b341674ef7d233fe896b5cd11b60119476e0a267031c9ee253dd62034ed62da74d5fbbe4b3e94ecf37fe6d92c79bbfdcd01f80578d50d3a0777e0b2bffceba47eda62eaf2f4de88aedbe18ca1af83db10eb665de645579765d78e502e1b6e42c3cbf6b88cf56fa3ca7ba0511e17f775d455dcba7034c713e77f1244c9e43b4cc5bacaff40b85b4bb49564626d00c2033991a594e99bb3ab5e9519daa2c61f9ab56f01cbd5d024e700d192e3b6bfa0d0bf7ea7cef461aa0f9ff4bc5d7348497bb182cbbc8503bcf2b5b678d5c1775ddc5ad971ec2560b1830eed898af0fe0b9150d085c0217434620f9175c8935adaf502f33253243a97c17df40d31f21195310dba6b6c8a526013eb65fd0af1b03efc1a7c39bff394873986fc3702ff98675481c3d991ab5fb086d6f404523d064b68843f369a7696b9378945521161b4ae2abe8a9ea4815251ac3232f67f40886d04e24cd48202b656179cd0e558f3d802f08c0c9a857f6c3534c9e1146d8626f29bdb7d0119c7328f0cddb3e198c02ed40b298ba1738594c17cfb92aedc3215ac21c192eeee442886c9b3f594cba4dbf2801b4906be0eeb6bc4c4a12c330436be3cc09db004c3ca179c08cfd9b1d7ac0f5a74c244067ad5aefcf0457bd0499cb6443830ac162cf207932c13834e0d51d4fb05f120cb5ca625eb4e2ee33802fa07002dc7bf8fab5b2c6e02266512c92f31def806ccfcdde63675a6747723ef69dab3ca8ffe5d2065e9ec9bef0a6519dba320901c1fc1b2d3ae9566b3401fa908ccd4f66ab46f6acaaba9be347eb4f6b8ccfdc180abcc5947ab0c7e2ad142d441d4764584438c40b5590daf1f8389c5242d119153d2d6cb20d37bcd77ea0efcdfa7e47955ed1c69c09dfc31257ac991cb63b0e6132f65164b7e6907653003162fef606634b3366ae841a59389289723d300ed8f243b816759c87b61d05c1747e233b1287d074e375a12e386dc2bf9c8958770143d7126684919020a2b3a969c20cd251fa682ba7cee03e3c44beb84ddebc798130aa86884080382f39c041293fcd2e49fc9b586fcc457047b7f6fb374df792a06d3db73e30b6791fbb4bca3dfce8fbdb9458241523c76199c481dcd519c2d73514c28e8f8ce48a3e001a70cd92804bd771ebbf20647b06c34fec322c66e6e93ba56cd12c65577f0f1843c16b746d08135fb5d132277610047abe79c3ba11fdb874e31859c0be6fb2d83495d33dc44b9633bbf9e2185912f94b1e05edb33e1c1941c8d252a5e042f6cb9b8d2b64f46a424e28f92424074fddfcfdde844f2050914584d7c1e642453b246557ae1cddbbc827710d55e35eb0193c4d993b877d954e1148dab36876e6f88c746c5cb8976833b5b0c76ef6fe109968d1b95bcce582dc0c4631153adcf6ba171aea551002cf199583c7a41d5283f8bda51568a47594ebe8b56d06f546bf2ba778d401019069b4fd6bb6de59b7c352f2ffa84dfc2ef7086b06bfdc9452b23427accb399b090cb0517afc7fbbc18304d3b6583331f3124905b2bc96cded1d72f8cb177cd31308c6fd1e6b63562b05da75ff210746fed5e15dfb25b7485e11b6d76a25f39ddab5d69f9bc2e50bbecf39442278eeda475ea644a6912dbb243253d904d0b4d565752a01e4f2b838c2c794b33d1df67930f9ff499b876dd4c1fb88dc6601448bf51120bf591043f50087606aeb1617d17fd099c36bf1c224fe546e1769199fa099d8563bb3dd33af70cdd0091521c21de0901b22d1844e171cdfc008f82f74445292a4c3fa24b2e91f11325777d6f3c2426561ba4c82dabd9dbd1e52bdc3fc131f60b43206e6907cce4e19525908e5bf9fcc55229e22485ca2e1076cb33f399fd8839ba46ca8d393cac72ef2032ff53e049e4d3d8f5216e309105dd67433716abc97b277a603305e087acc8d199fa28c30ed09796acec7ca83e6ce1d4ce089811c594896d03935beea1d7e020cb45cbd7224ca7a638c57ebbc8fa103a610032f84e9f6c289289994be47e5661288f536d7b52b96c6cc4257014689b2059ea2d3da94043ee81b9efa276c3d45f53b41502b9fb414b7db2f5c1b3e9df9e3d91182ed9b9c7debaa25a99c74df8d88c31ff57f93cb418755eb2b318cbdd19dfda85bba62bbf56ccffddd1fd0e67ea49c0480772917ead31456ca959f7cf3fdc408c54bc90e921f278e6bfa0bb7a1b1172450895a6f948ad8870d78cb4254d1a5d23191df03c326d9ccebeee497d436da405070051fc89101a380d39f3c15747106ed2e82d0c9ab71d4f8914ae2aff6ba3d6a82857cd89db7b03b4198c381c6146987677313e580542145d8f35ff790e8cb89e2517dc9d7174aa8a04fa503436d0e5d5aa6c0e8500f3d335fe41a0607513a13fe240c56340099ecee83c0e21177c36284e489b8f9c953057e3107e1028f7645443c8afd794bcc96f33542bf5f2a6850474bc933e70a86dde743c4e256d1d643b4350a6145653b03523286d72df06adc8b842b62cd4a51f9cba01f1de0c05d7505d8ff5744fed3b8791ee7f8500d35a888cbf5f74e60197492e3e2a26e7541dbe3f7ffe0ef642d9336b7dc172462520066afa85d5d5942048ee79592811f31c2ead9c4b3e31022de4af612503b8c1646c6d2d9eda78f7e0cea07d40da44edb176c48aace5de6372e7e5099dd2595ec38e4eaef42a022c952ce5a4f646e1e203d4902ae2ae7e852268e17dc272e8eaaa79b1c7b7f19eed616355803e96930ab7c8c5e35e7ad5e820800e06132c7f74c210d1b077ecb6f4c70e964d771d468006da668c0d7fd8c505eb3e8d8b5b8653237650a146ee08fc9fe7b7348fb21593304e57f279205a85846816199c63307ee03bbad69c6010cc077bd1b3cf6f549922db574bd7da079e76fc7a1f08cf9324e7cef6a7313ebc592f668c0b77e61ba38355c2860b813974f274ce2088a3b6af0dec1fc37168c970f3b9c4802057dd72612dd754d424999d86f60ab0c0c55a3b57882cd4d4a86ebe6fd2a438a414e3e9aad7aed692121a3feab494e986bd6030f9e06ca14ecb9564f683bacd8aede4679cb0990cd9bea43b120bddd0592a3b088bb1dc2f612ae77debe90f5a7ae77aecfe8b95ddf32fcab193eba7bfa68a4395b58f674acea35939dd4b1211cfa1ca3fe1150f2c8c316ac6c0d03220b2ac93918856cda87bd5d89616719bcc70dc09b1e10312b5ed88a15978f59215f74f490880350ba02df42b702c933fa7896d1761c8a51a20a0ce687bcbb485a2b8f564722e01abb864c7b856330a4212b1b46f77602f1c95ad0e48e029901262396565f9872371faa1dcea8ecc8b9e52a9c3c22fc6a280cfe8cd62387ca4f0065d5a6196c0ef5cec23d20ac0d668e6f9126a9945ba68690c8e74a49ba95a7e891e2feb357b942cc53e272c319e936700166833c1586908e37a8025afeff67345ac625a6c5046eb08d5e2f72c8e281d96446d679fd5c8426df97896c8ae0779a8e66490064b1a20df2e512c3f0cc15f07c944007565e6ed31718c905bf82bb27a4067b9521cc895e4ddeff4caf8b6716d0aeb127fd51dc671eb94f57db241c371d7fd2080d69539c64295527876debcea64652f72e7ec761d831354b7fe240c417fac49d03ba2e5cc3f0f12fe4d929c44a55d0436619d112abf8982916bad6d4780a4a4bffa3af2a8c4c9f64d46d0d9245213734870deb2f7e4e30ee11d341cea10146c203c096f48473cd7d5ac077c2705a83c1faebf41093103a9ce81b9e8698b0c8c197f14145e2829c645fac363af3696c556403406011df606c378c5d8354124deaf719b48e3bd403cf2ce4c2862053e822c8104c3f9616dbc4e6adbc081c063998bec93b63a0f5ba6040a126f7c6eb1adfbcf605f67103dcd03f5d117dbe984dac6fd4d52c8d1e3227c60dcc8d94b5446e4856ab6e1cd1465933a98daedbb78c3b',
		);
		tx = Transaction.fromTxData(txData);
		expect(tx.isSigned()).toBe(false);
		tx = tx.sign(seed);
		expect(tx.isSigned()).toBe(true);

		tx = Transaction.fromTxData(txData);
		expect(tx.isSigned()).toBe(false);
		const rawUnsigned = tx.serialize();
		tx = tx.sign(seed);
		const rawSigned = tx.serialize();
		expect(tx.isSigned()).toBe(true);

		tx = Transaction.fromSerializedTx(rawUnsigned);
		expect(tx.isSigned()).toBe(false);
		tx = tx.sign(seed);
		expect(tx.isSigned()).toBe(true);
		tx = Transaction.fromSerializedTx(rawSigned);
		expect(tx.isSigned()).toBe(true);

		const signedValues = RLP.decode(Uint8Array.from(rawSigned));
		tx = Transaction.fromValuesArray(signedValues as Uint8Array[]);
		expect(tx.isSigned()).toBe(true);
		tx = Transaction.fromValuesArray(signedValues.slice(0, 6) as Uint8Array[]);
		expect(tx.isSigned()).toBe(false);
	});
});
